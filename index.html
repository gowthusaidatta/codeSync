<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>CodeSync - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Optional: Add some basic styling for the message */
        .error-message {
            color: #ef4444; /* red-500 */
            font-weight: bold;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen">

    <div class="text-center bg-gray-800 p-8 rounded-lg shadow-xl max-w-md w-full">
        <h1 class="text-4xl font-bold mb-4 text-blue-400">Welcome to CodeSync Dashboard! ðŸš€</h1>
        
        <p id="errorMessage" class="error-message hidden">
            </p>

        <div id="userInfoSection" class="hidden">
            <p class="text-xl mb-4">Logged in as: <span id="displayUsername" class="font-semibold text-green-400"></span></p>
            <p class="text-md mb-6">Email: <span id="displayEmail" class="text-gray-300"></span></p>
            <p id="idTokenPreview" class="text-gray-400 mb-6 text-sm break-all">ID Token: <span class="font-mono"></span></p>
        </div>

        <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-lg">
            Logout
        </button>
    </div>

    <script>
        // --- Cognito Configuration (Must match your App Client settings) ---
        const COGNITO_DOMAIN = "https://us-east-1rmhlkughs.auth.us-east-1.amazoncognito.com";
        const CLIENT_ID = "4g0bo9ac68vq4g817v1je4e5sf";
        // This MUST match the 'Callback URL(s)' and 'Sign-out URL(s)' in your Cognito App Client
        const REDIRECT_TO_LOGIN_PAGE_URI = "https://gowthusaidatta.github.io/codeSync/index.html"; 
        // Assuming your login page is index.html

        // --- UI Elements ---
        const userInfoSection = document.getElementById("userInfoSection");
        const displayUsername = document.getElementById("displayUsername");
        const displayEmail = document.getElementById("displayEmail");
        const idTokenPreview = document.getElementById("idTokenPreview");
        const errorMessageDiv = document.getElementById("errorMessage");

        /**
         * Parses a JWT token to extract its payload.
         * @param {string} token - The JWT string.
         * @returns {object|null} The decoded JWT payload, or null if invalid.
         */
        function parseJwt(token) {
            if (!token) return null;
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                console.error("Error parsing JWT:", e);
                return null;
            }
        }

        /**
         * Displays an error message.
         * @param {string} message - The message to display.
         */
        function showErrorMessage(message) {
            errorMessageDiv.textContent = message;
            errorMessageDiv.classList.remove("hidden");
        }

        /**
         * Hides the error message.
         */
        function hideErrorMessage() {
            errorMessageDiv.classList.add("hidden");
            errorMessageDiv.textContent = "";
        }

        // --- Authentication Check on Page Load ---
        document.addEventListener('DOMContentLoaded', () => {
            const idToken = sessionStorage.getItem("id_token"); // Check for ID Token

            if (!idToken) {
                showErrorMessage("You must log in first to access the dashboard.");
                // Redirect to the main login page after a short delay
                setTimeout(() => {
                    window.location.href = REDIRECT_TO_LOGIN_PAGE_URI;
                }, 2000); // Redirect after 2 seconds
            } else {
                const decodedIdToken = parseJwt(idToken);
                if (decodedIdToken) {
                    userInfoSection.classList.remove("hidden");
                    displayUsername.textContent = decodedIdToken.preferred_username || decodedIdToken.email || decodedIdToken.sub || "N/A";
                    displayEmail.textContent = decodedIdToken.email || "N/A";
                    // Display a truncated version of the ID token for debugging/info
                    idTokenPreview.querySelector('span').textContent = `${idToken.slice(0, 30)}...${idToken.slice(-10)}`;
                    idTokenPreview.classList.remove("hidden");
                } else {
                    showErrorMessage("Invalid or corrupted login session. Please log in again.");
                    sessionStorage.clear(); // Clear potentially bad tokens
                    setTimeout(() => {
                        window.location.href = REDIRECT_TO_LOGIN_PAGE_URI;
                    }, 2000);
                }
            }
        });

        // --- Logout Function ---
        function logout() {
            sessionStorage.clear(); // Clear all tokens (ID, Access, Refresh)
            // Redirect to Cognito logout endpoint to clear Cognito session
            window.location.href = `${COGNITO_DOMAIN}/logout?client_id=${CLIENT_ID}&logout_uri=${encodeURIComponent(REDIRECT_TO_LOGIN_PAGE_URI)}`;
        }
    </script>

</body>
</html>
